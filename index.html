<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í—¤ì–´ ìŠ¤íƒ€ì¼ëŸ¬</title>
    <link rel="stylesheet" href="style.css?v=final_v10">
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
</head>

<body>
    <div class="container">
        <header>
            <img src="title_logo.png" alt="AI Hair Styler" class="title-logo">
            <p class="subtitle">ë‚˜ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ì„ ì°¾ì•„ë³´ì„¸ìš”</p>
        </header>

        <!-- Usage Count Badge -->
        <div class="usage-badge" id="usageBadge">
            ë‚¨ì€ íšŸìˆ˜: <span id="remainingCount">5</span>íšŒ
        </div>

        <!-- Upload Section -->
        <label class="upload-area" id="uploadArea" for="userPhoto">
            <input type="file" id="userPhoto" accept="image/*" class="visually-hidden">

            <div class="upload-placeholder" id="uploadPlaceholder">
                <span class="icon">ğŸ“¸</span>
                <span>ì‚¬ì§„ ì—…ë¡œë“œ</span>
                <span style="font-size: 0.8rem; opacity: 0.7;">(ì •ë©´ ì–¼êµ´ ê¶Œì¥)</span>
            </div>

            <img id="previewImage" class="hidden" alt="Preview">
            <button id="removeImage" class="remove-btn hidden">Ã—</button>
        </label>

        <!-- Gender Selection -->
        <div class="tabs">
            <button class="tab-pill active" data-gender="male">ë‚¨ì„± ìŠ¤íƒ€ì¼</button>
            <button class="tab-pill" data-gender="female">ì—¬ì„± ìŠ¤íƒ€ì¼</button>
        </div>

        <!-- Style Grid -->
        <div class="style-grid" id="styleGrid">
            <!-- Styles will be populated by JS -->
        </div>
    </div>

    <!-- Style Detail Modal -->
    <div id="styleDetailModal" class="style-detail-modal">
        <div class="style-detail-content">
            <button id="closeDetailBtn" class="close-detail-btn">Ã—</button>

            <div class="detail-image-container">
                <div id="detailImage" class="detail-image"></div>
            </div>

            <div class="detail-info">
                <h3 id="detailTitle" class="detail-title">Style Name</h3>
                <p class="detail-desc">ì´ ìŠ¤íƒ€ì¼ë¡œ ìƒˆë¡œìš´ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>

            <button id="generateBtn" class="generate-btn">
                <span class="btn-text">ì´ ìŠ¤íƒ€ì¼ë¡œ ìƒì„±í•˜ê¸° âœ¨</span>
                <div class="loader hidden"></div>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal hidden">
        <div class="auth-content">
            <h3>ë¬´ë£Œ ì‚¬ìš© íšŸìˆ˜ ë§Œë£Œ</h3>
            <p>ì¶”ê°€ ì‚¬ìš©ì„ ìœ„í•´ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

            <div class="security-code-display">
                ì¸ì¦ ë²ˆí˜¸: <span id="securityCodeDisplay"></span>
            </div>

            <div class="auth-input-group">
                <input type="text" id="authPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="4">
                <button id="verifyBtn" class="btn-primary">í™•ì¸</button>
            </div>
            <p class="auth-hint">ë¹„ë°€ë²ˆí˜¸ = (ì¸ì¦ë²ˆí˜¸ ê° ìë¦¬ì˜ í•©) + (ì¶”ê°€í•  íšŸìˆ˜)</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultSection" class="result-modal hidden">
        <div class="modal-content">
            <h3 style="text-align: center; margin-bottom: 10px;">ìƒì„± ê²°ê³¼</h3>
            <div class="result-image-container">
                <img id="resultImage" src="" alt="Generated Hairstyle">
            </div>
            <div class="modal-actions">
                <button id="closeResult" class="btn-secondary">ë‹«ê¸°</button>
                <button id="downloadBtn" class="btn-primary">ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Configuration
        const CONFIG = {
            MODEL_NAME: "gemini-3-pro-image-preview",
            // ì¤‘ìš”: ì´ê²ƒì€ ê¸°ë³¸ì ì¸ ë‚œë…í™” ê¸°ìˆ ì…ë‹ˆë‹¤.
            // ê²°ì •ì ì¸ ê³µê²©ìê°€ í‚¤ë¥¼ ì°¾ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.
            // ì‹¤ì œ ë³´ì•ˆì„ ìœ„í•´ì„œëŠ” Google Cloud Consoleì—ì„œ HTTP ë¦¬í¼ëŸ¬ ì œí•œì„ ì‚¬ìš©í•˜ì„¸ìš”.
            KEY_PART1: "AIzaSyCDLQxtK8MRFPkb",
            KEY_PART2: "M0lgW6l1rJjoO9dTj-s"
        };

        // State
        let state = {
            selectedGender: "male",
            selectedStyleIndex: null,
            userImageFile: null,
            styles: {
                male: [],
                female: []
            },
            remainingCount: 5,
            currentSecurityCode: null
        };

        // DOM Elements
        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            userPhotoInput: document.getElementById('userPhoto'),
            previewImage: document.getElementById('previewImage'),
            removeImageBtn: document.getElementById('removeImage'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),

            tabs: document.querySelectorAll('.tab-pill'),
            styleGrid: document.getElementById('styleGrid'),
            usageBadge: document.getElementById('usageBadge'),
            remainingCount: document.getElementById('remainingCount'),

            // Style Detail Modal
            styleDetailModal: document.getElementById('styleDetailModal'),
            closeDetailBtn: document.getElementById('closeDetailBtn'),
            detailImage: document.getElementById('detailImage'),
            detailTitle: document.getElementById('detailTitle'),
            generateBtn: document.getElementById('generateBtn'),

            // Auth Modal
            authModal: document.getElementById('authModal'),
            securityCodeDisplay: document.getElementById('securityCodeDisplay'),
            authPassword: document.getElementById('authPassword'),
            verifyBtn: document.getElementById('verifyBtn'),

            resultSection: document.getElementById('resultSection'),
            resultImage: document.getElementById('resultImage'),
            downloadBtn: document.getElementById('downloadBtn'),
            closeResultBtn: document.getElementById('closeResult')
        };


        // Initialize
        function init() {
            loadUsageCount();
            setupEventListeners();
            loadAndSliceStyles();
            updateUsageUI();

            // Expose generateHairstyle to window for fallback access
            window.generateHairstyle = generateHairstyle;
        }

        function loadUsageCount() {
            const savedCount = localStorage.getItem('hairstyle_usage_count');
            if (savedCount !== null) {
                state.remainingCount = parseInt(savedCount, 10);
            }
        }

        function saveUsageCount() {
            localStorage.setItem('hairstyle_usage_count', state.remainingCount);
            updateUsageUI();
        }

        function updateUsageUI() {
            elements.remainingCount.textContent = state.remainingCount;
            if (state.remainingCount <= 0) {
                elements.usageBadge.classList.add('empty');
            } else {
                elements.usageBadge.classList.remove('empty');
            }
        }

        function setupEventListeners() {
            // File Upload
            elements.userPhotoInput.addEventListener('change', handleFileSelect);

            elements.removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent label click bubbling
                e.stopPropagation();
                clearImage();
            });

            // Tabs
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.selectedGender = tab.dataset.gender;
                    state.selectedStyleIndex = null; // Reset selection on tab switch
                    renderStyles();
                });
            });

            // Style Detail Modal
            elements.closeDetailBtn.addEventListener('click', closeStyleDetail);
            elements.styleDetailModal.addEventListener('click', (e) => {
                if (e.target === elements.styleDetailModal) closeStyleDetail();
            });

            // Generate (Inside Modal)
            if (elements.generateBtn) {
                elements.generateBtn.addEventListener('click', generateHairstyle);
            } else {
                console.error("Generate button not found!");
            }

            // Auth Modal
            elements.verifyBtn.addEventListener('click', verifyPassword);

            // Result Modal
            if (elements.closeResultBtn) {
                elements.closeResultBtn.addEventListener('click', () => {
                    elements.resultSection.classList.add('hidden');
                });
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                state.userImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    elements.previewImage.src = e.target.result;
                    elements.previewImage.classList.remove('hidden');
                    elements.removeImageBtn.classList.remove('hidden');
                    elements.uploadPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            state.userImageFile = null;
            elements.userPhotoInput.value = '';
            elements.previewImage.src = '';
            elements.previewImage.classList.add('hidden');
            elements.removeImageBtn.classList.add('hidden');
            elements.uploadPlaceholder.classList.remove('hidden');
        }

        async function loadAndSliceStyles() {
            const maleLabels = ["í…ìŠ¤ì²˜ í¬ë¡­", "ì•„ì´ë¹„ ë¦¬ê·¸ ì»·", "ì‰¼í‘œ ë¨¸ë¦¬", "ê°€ë¥´ë§ˆ íŒ", "ì‹œìŠ¤ë£¨ ëŒ„ë””", "ë¡± íŠ¸ë¦¼", "ë¦¬í”„ ì»·", "ì†Œí”„íŠ¸ íˆ¬ë¸”ëŸ­", "ìŠ¬ë¦­ ë°±", "ë§¨ ë²ˆ"];
            const femaleLabels = ["íˆí”¼ íŒ", "ë ˆì´ì–´ë“œ Cì»¬", "ë³´ë¸Œ ì»·", "ê¸´ ì›¨ì´ë¸Œ", "í—ˆì‰¬ ì»·", "í’€ë±…", "ë°œë ˆì•„ì¥¬ ì»¬ëŸ¬", "ë°˜ë¬¶ìŒ", "ìˆì»·", "ë•‹ì€ ë¨¸ë¦¬"];

            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            };

            try {
                const [manImg, womanImg] = await Promise.all([
                    loadImage('man.png'),
                    loadImage('woman.png')
                ]);

                const sliceImage = (img, gender, labels) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const w = img.naturalWidth;
                    const h = img.naturalHeight;
                    const cols = 5;
                    const rows = 2;
                    const cellWidth = w / cols;
                    const cellHeight = h / rows;

                    // Text area height to exclude (approx 70px from bottom of each cell)
                    const textHeight = 70;
                    const finalHeight = cellHeight - textHeight;

                    let idx = 0;
                    for (let row = 0; row < rows; row++) {
                        for (let col = 0; col < cols; col++) {
                            if (idx >= labels.length) break;

                            let sx = col * cellWidth;
                            let sy = row * cellHeight;
                            let currentHeight = finalHeight;

                            canvas.width = cellWidth;
                            canvas.height = currentHeight;

                            // Draw only the image part, excluding the bottom text area
                            ctx.drawImage(img, sx, sy, cellWidth, currentHeight, 0, 0, cellWidth, currentHeight);

                            const dataURL = canvas.toDataURL('image/png');
                            state.styles[gender].push({
                                id: `${gender.charAt(0)}${idx + 1}`,
                                src: dataURL,
                                label: labels[idx]
                            });
                            idx++;
                        }
                    }
                };

                sliceImage(manImg, 'male', maleLabels);
                sliceImage(womanImg, 'female', femaleLabels);

                console.log("Styles sliced and loaded:", state.styles);
                renderStyles();

            } catch (error) {
                console.error("Failed to load style images", error);
                alert("ìŠ¤íƒ€ì¼ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function renderStyles() {
            elements.styleGrid.innerHTML = '';
            const currentStyles = state.styles[state.selectedGender];

            currentStyles.forEach((style, index) => {
                const div = document.createElement('div');
                div.className = `style-item ${state.selectedStyleIndex === index ? 'selected' : ''}`;
                div.onclick = () => openStyleDetail(index);

                // Use IMG tag instead of background image for better fit
                const img = document.createElement('img');
                img.src = style.src;
                img.className = 'style-item-img-tag';
                img.alt = style.label;

                div.appendChild(img);
                elements.styleGrid.appendChild(div);
            });
        }

        function openStyleDetail(index) {
            state.selectedStyleIndex = index;
            const currentStyles = state.styles[state.selectedGender];
            const style = currentStyles[index];

            // Update Modal Content
            elements.detailTitle.textContent = style.label;

            // For modal, we can use the sliced image directly
            elements.detailImage.style.backgroundImage = `url('${style.src}')`;
            elements.detailImage.style.backgroundPosition = 'center';
            elements.detailImage.style.backgroundSize = "contain";
            elements.detailImage.style.backgroundRepeat = "no-repeat";

            // Show Modal
            elements.styleDetailModal.classList.add('open');

            renderStyles();
        }

        function closeStyleDetail() {
            elements.styleDetailModal.classList.remove('open');
        }

        function showAuthModal() {
            // Generate 4-digit random number
            const randomCode = Math.floor(1000 + Math.random() * 9000);
            state.currentSecurityCode = randomCode;

            elements.securityCodeDisplay.textContent = randomCode;
            elements.authPassword.value = '';
            elements.authModal.classList.remove('hidden');
        }

        function verifyPassword() {
            const input = elements.authPassword.value;
            if (!input) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const codeStr = state.currentSecurityCode.toString();
            let sum = 0;
            for (let char of codeStr) {
                sum += parseInt(char, 10);
            }

            // Parse input: last digit is extra count, rest is sum
            if (input.length < 2) return alert("ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ì…ë‹ˆë‹¤.");

            const extraCountStr = input.slice(-1); // Last digit
            const sumInputStr = input.slice(0, -1); // Rest

            const extraCount = parseInt(extraCountStr, 10);
            const sumInput = parseInt(sumInputStr, 10);

            if (isNaN(extraCount) || isNaN(sumInput)) {
                return alert("ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            if (sumInput === sum) {
                // Success
                state.remainingCount += extraCount;
                saveUsageCount();
                elements.authModal.classList.add('hidden');
                alert(`ì¸ì¦ ì„±ê³µ! ${extraCount}íšŒê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                closeStyleDetail(); // Close detail to refresh state if needed
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        async function generateHairstyle() {
            console.log("generateHairstyle called"); // Debug log

            if (state.remainingCount <= 0) {
                closeStyleDetail();
                showAuthModal();
                return;
            }

            // API Key ì¬ì¡°í•©
            const API_KEY = CONFIG.KEY_PART1 + CONFIG.KEY_PART2;

            if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
                closeStyleDetail();
                return alert("ì†ŒìŠ¤ì½”ë“œì˜ CONFIG.API_KEYì— ìœ íš¨í•œ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            if (!state.userImageFile) {
                closeStyleDetail();
                return alert("ë¨¼ì € ë³¸ì¸ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
            }

            setLoading(true);

            try {
                const module = await import("@google/generative-ai");

                let GoogleGenerativeAI = module.GoogleGenerativeAI;
                if (!GoogleGenerativeAI && module.default) {
                    GoogleGenerativeAI = module.default.GoogleGenerativeAI;
                }

                if (!GoogleGenerativeAI) {
                    throw new Error("GoogleGenerativeAI í´ë˜ìŠ¤ë¥¼ ëª¨ë“ˆì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: CONFIG.MODEL_NAME });

                // Convert user image to base64
                const userImageBase64 = await fileToGenerativePart(state.userImageFile);

                // Get selected style image (sliced)
                const currentStyles = state.styles[state.selectedGender];
                if (!currentStyles || !currentStyles[state.selectedStyleIndex]) {
                    throw new Error("ì„ íƒëœ ìŠ¤íƒ€ì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                const selectedStyle = currentStyles[state.selectedStyleIndex];

                // Use the sliced image data directly
                const styleImageBase64 = {
                    inlineData: {
                        data: selectedStyle.src.split(',')[1],
                        mimeType: "image/png"
                    }
                };

                const prompt = `
                    You are an expert hair stylist and professional image editor.
                    I will provide two images:
                    1. User Photo: The target person.
                    2. Hairstyle Reference: The style to apply.

                    Task: Realistically apply the hairstyle from the Reference image to the person in the User Photo.

                    Critical Requirements:
                    - PRESERVE the user's face identity, facial features, skin tone, expression, lighting, and background EXACTLY as they are. Do NOT modify the face.
                    - ADAPT the reference hairstyle to fit the user's head shape and pose naturally.
                    - BLEND the hair edges seamlessly with the user's forehead and ears.
                    - MATCH the lighting and shadows of the new hair to the user's original photo.
                    - Return ONLY the generated image.
                `;

                console.log("Sending request to Gemini API..."); // Debug log
                const result = await model.generateContent([
                    prompt,
                    userImageBase64,
                    styleImageBase64
                ]);

                console.log("Full Result Object:", result);
                const response = await result.response;

                // Handle Image Response
                let generatedImageBase64 = null;

                if (response.candidates && response.candidates[0] && response.candidates[0].content && response.candidates[0].content.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('image/')) {
                            generatedImageBase64 = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            break;
                        }
                    }
                }

                if (generatedImageBase64) {
                    // Decrement count on success
                    state.remainingCount--;
                    saveUsageCount();

                    elements.resultImage.src = generatedImageBase64;
                    closeStyleDetail(); // Close detail modal
                    elements.resultSection.classList.remove('hidden'); // Show result modal

                    // Setup download button
                    elements.downloadBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.href = generatedImageBase64;
                        link.download = `hairstyle-result-${Date.now()}.png`;
                        link.click();
                    };
                } else {
                    let text = "";
                    try {
                        text = response.text();
                    } catch (e) {
                        text = JSON.stringify(response, null, 2);
                    }
                    console.warn("No image found in response. Text content:", text);
                    alert("ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸(F12)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\nì‘ë‹µ ë‚´ìš©: " + text.substring(0, 100) + "...");
                }

            } catch (error) {
                console.error("Error:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                setLoading(false);
            }
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type || "image/png"
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function setLoading(isLoading) {
            const btn = elements.generateBtn;
            if (!btn) return;

            const text = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader');

            if (isLoading) {
                btn.disabled = true;
                if (text) text.classList.add('hidden');
                if (loader) loader.classList.remove('hidden');
            } else {
                btn.disabled = false;
                if (text) text.classList.remove('hidden');
                if (loader) loader.classList.add('hidden');
            }
        }

        // Start
        try {
            init();
            console.log("App initialized successfully");
        } catch (e) {
            console.error("App initialization failed:", e);
            alert("ì•±ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    </script>
</body>

</html>